# Mapping ç®—æ³•èµ›é“

----

### Problem

Mapping é—®é¢˜æœ¬è´¨æ˜¯å›¾è®ºé—®é¢˜ï¼šå­å›¾åŒæ„ã€å›¾åŠ¨æ€è§„åˆ’ç­‰

- ç»™å®šèŠ¯ç‰‡æ‹“æ‰‘ç»“æ„ã€çº¿è·¯éœ€æ±‚
  - æ•°æ®æ¯”ç‰¹æ•°é‡ Nã€è¾…åŠ©æ¯”ç‰¹æ•°é‡ N'ã€ä¸¤æ¯”ç‰¹é—¨æ•°é‡ nã€ä¸¤æ¯”ç‰¹ä½ç½®å¸ƒå±€ã€çº¿è·¯æ·±åº¦ mã€çº¿è·¯è¿è¡Œä¿çœŸåº¦ f
- æ‰¾åˆ°åˆé€‚çš„æ¯”ç‰¹æ˜ å°„é›†åˆ
- æœ€ç»ˆæµ‹è¯•: 10 æ¯”ç‰¹å¹¶è¡Œ XEB å®éªŒ + GHZ æ€çº¿è·¯
  - ä¸»è¦è¯„ä»·æŒ‡æ ‡ 
    - æ˜ å°„ç®—æ³•èƒ½å¦æ‰§è¡Œ A = 1 (æˆåŠŸ) / 0 (å¤±è´¥)
  - æ¬¡è¦è¯„ä»·æŒ‡æ ‡
    - XEB å®éªŒåœ¨ [8,12,16,20] å±‚ï¼Œæ¯ç§æƒ…å†µä¸‹ 100 ä¸ªéšæœºçº¿è·¯ï¼Œæ¯æ¡çº¿è·¯ 4000 æ¬¡é‡‡æ ·ä¸‹çš„ä¿çœŸåº¦ F (å  60% åˆ†å€¼)
    - æ¯”ç‰¹æ˜ å°„ç®—æ³•æ‰§è¡Œæ—¶é—´ T (å  40% åˆ†å€¼)
  - è¯„åˆ†å…¬å¼: A * (Fè¶…è¿‡æ‰€æœ‰æˆç»©çš„æ­£æ€åˆ†å¸ƒçš„sigmaå€¼ * 0.6 + Tè¶…è¿‡æ‰€æœ‰æˆç»©çš„æ­£æ€åˆ†å¸ƒçš„sigmaå€¼ * 0.4)
    - ğŸ¤”: ä½ ç¡®å®šæœ€ååˆ†æ•°åˆ†å¸ƒæ˜¯ä¸ªæ­£æ€è€Œä¸æ˜¯é•¿å°¾ï¼Œå†µä¸”æ ·æœ¬æ•°è¶³å¤Ÿï¼Ÿ

â„¹ å¯å‚è€ƒ IBM Qiskit ä¸­çš„è§£å†³æ–¹æ¡ˆ: TrivialLayout, VF2Layout, SabreLayout, DenseLayout


### Solution

âš  æˆ‘ä»¬çš„è§£å†³æ–¹æ¡ˆ **ä¸ä¾èµ–ä»»ä½•ç¬¬ä¸‰æ–¹åº“** :)

- é¦–å…ˆå°è¯•ç”¨ **VF2++ ç®—æ³•** å¯»æ‰¾å®Œç¾åŒ¹é…
  - æå‡ºäº† TrimFid é«˜æ•ˆå‰ªææ³•åˆ™
- å…¶æ¬¡ä½¿ç”¨ **SABRE å¯å‘å¼ç®—æ³•** å¯»æ‰¾éå®Œç¾åŒ¹é…
  - åœ¨å¯å‘å¼æŸå¤±å‡½æ•°ä¸­å¼•å…¥äº†å«ä¿çœŸåº¦çš„é¡¹ FM


### Get Started!!

â„¹ å¯ä¾éœ€è¦ä¸»åŠ¨è°ƒæ•´ç®—æ³•è¿è¡Œæ—¶é—´ `--ttl`

#### run

```shell
# é»˜è®¤é…ç½® (GHZ circuit)
python run_mapping.py -N 9 -O .\out\9qubit_ghz.json
# é»˜è®¤é…ç½® (random CZ circuit)
python run_mapping.py -R 8 -O .\out\8depth_RZ.json
# é»˜è®¤é…ç½® (è‡ªå®šä¹‰æ–‡ä»¶è·¯å¾„ï¼Œåº”ä¸æ¯”èµ›æä¾›çš„ GHZ æ•°æ®é›†ä¿æŒä¸€è‡´)
python run_mapping.py -I <path/to/input.json> -O <path/to/output.json>

# é™åˆ¶æ¯ä¸ªçº¿è·¯è¿è¡Œæ—¶é—´ 10sï¼Œä¸ä¿å­˜ç»“æœ
python run_mapping.py -N 9 --ttl 10
```

#### benchmark

âšª [VF2++ only](./run_mapping_vf2pp.py)

Test sample **GHZ** circuits, without time limit

| n_qubits | found n_mappings | best_fid | runtime (s) |
| :-: | :-: | :-: | :-: |
|  9 |   3396 | 0.56865 |   0.19 |
| 11 |   5342 | 0.49657 |   0.65 |
| 13 |  10198 | 0.43491 |   2.35 |
| 15 |  16562 | 0.38159 |   7.70 |
| 17 |  35131 | 0.33111 |  23.76 |
| 19 |  86974 | 0.28707 |  71.21 |
| 21 | 210207 | 0.24485 | 205.15 |

Test sample **GHZ** circuits, with different time limits (cell `n_mappings/fidelity` in table)

| n_qubits | tlim=10s | tlim=5s | tlim=3s | tlim=1s |
| :-: | :-: | :-: | :-: | :-: |
| 23 | 282692 / 0.20525 | 154626 / 0.20525 | 91269 / 0.192091 | 33048 / 0.192091 |
| 25 | 265459 / 0.16654 | 130253 / 0.16654 | 80324 / 0.166544 | 28796 / 0.161358 |
| 27 | 227907 / 0.13649 | 116116 / 0.13649 | 68927 / 0.132236 | 23652 / 0.131880 |
| 29 | 197225 / 0.11291 |  94761 / 0.10808 | 54696 / 0.108078 | 18791 / 0.102724 |
| 31 | 147393 / 0.08996 |  70585 / 0.08711 | 39930 / 0.086913 | 15484 / 0.084355 |
| 33 |  99136 / 0.07414 |  47744 / 0.07349 | 28221 / 0.072253 | 10218 / 0.067015 |
| 35 |  56383 / 0.06177 |  24660 / 0.06131 | 15666 / 0.061310 |  4880 / 0.056254 |
| 37 |  25848 / 0.05153 |  12312 / 0.05153 |  7070 / 0.051026 |  1297 / 0.044184 |

âšª [SABRE only](./run_mapping_sabre.py)

Test sample **GHZ** circuits, with fixed time limit 10s

| n_qubits | best_fid | runtime (s) |
| :-: | :-: | :-: |
|  7 | 0.59150 |  1.10 |
|  9 | 0.50695 |  1.78 |
| 11 | 0.41351 |  2.56 |
| 13 | 0.35991 |  3.58 |
| 15 | 0.26143 |  4.67 |
| 17 | 0.19584 |  5.82 |
| 19 | 0.18153 |  7.19 |
| 21 | 0.14269 |  8.28 |
| 23 | 0.10347 |  9.60 |
| 25 | Timeout | 10.00 |

Test **random CZ** circuits, with fixed time limit 10s (cell `fidelity/runtime` in table)

| n_qubits \ n_depths | 8 | 12 | 16 | 20 |
| :-: | :-: | :-: | :-: | :-: |
|  8 | 0.58625 / 2.53 | 0.52391 / 3.48 | 0.45376 /  5.19 | 0.43105 /  5.95 |
| 10 | 0.54288 / 2.65 | 0.48948 / 3.63 | 0.44957 /  6.52 | 0.33861 /  8.41 |
| 12 | 0.55912 / 2.48 | 0.41068 / 5.64 | 0.38319 /  6.92 | 0.35058 /  8.47 |
| 14 | 0.52483 / 2.71 | 0.44183 / 5.09 | 0.35204 / 10.00 | 0.26380 / 10.00 |
| 16 | 0.52092 / 3.30 | 0.34872 / 6.64 | 0.29151 /  8.74 | 0.23546 / 10.00 |
| 18 | 0.50709 / 3.27 | 0.35865 / 7.89 | 0.34263 /  9.82 | 0.22073 / 10.00 |
| 20 | 0.50260 / 2.47 | 0.36799 / 7.56 | 0.32026 / 10.00 | 0.21086 / 10.00 |


### references

- VF2
  - https://networkx.org/documentation/stable/reference/algorithms/isomorphism.html
  - https://www.rustworkx.org/api/algorithm_functions/isomorphism.html
- VF2++ standalone impl.
  - https://github.com/Kahsolt/Huawei-Algotester-2024-Subgrahh-Isomorphism-Checker
- SABRE
  - QuICT: https://quict-docs.readthedocs.io/aa/latest/API/quict/qcda/mapping/Sabre/
  - Qiskit: https://github.com/Qiskit/qiskit/blob/main/qiskit/transpiler/passes/layout/sabre_layout.py

----
by Armit
2024/07/02 
